<% internal_evaluation = valuation_assignment.proposal.internal_evaluations.find { |e| e.decidim_author_id == valuation_assignment.valuator_role.decidim_user_id } %>
<% valuator = present(valuation_assignment.valuator) %>

<div>
  <%= link_to_if(valuator.profile_path.present?, valuator.name, valuator.profile_path, target: :blank) %>
  <% if internal_evaluation.present? %>
    <% internal_evaluation = Decidim::InternalEvaluation::Admin::InternalEvaluationPresenter.new(internal_evaluation) %>
    <%= internal_evaluation.update_date %>

    <strong class="label <%= internal_evaluation.state_css_class %>" style="<%= internal_evaluation.state_css_style %>">
      <%= internal_evaluation.state_title %>
    </strong>

    <%= internal_evaluation.formatted_body %>
  <% end %>

  <% if valuator == current_user %>
    <button class="button button__sm button__transparent-secondary mt-6 md:mt-12 md:self-start" data-dialog-open="evaluateModal">
      <%= icon "pencil-line", class: "fill-current" %>
    </button>

    <%= decidim_modal id: "evaluateModal", class: "flag-modal" do %>
      <% url = internal_evaluation.present? ? proposal_internal_evaluation_path(proposal, internal_evaluation) : proposal_internal_evaluations_path(proposal) %>

      <%= decidim_form_for(internal_evaluation_form, url:, html: { class: "form form-defaults edit_proposal_internal_evaluation" }) do |f| %>
        <%= render partial: "/decidim/internal_evaluation/admin/internal_evaluations/form", object: f %>
      <% end %>
    <% end %>
  <% end %>
</div>
